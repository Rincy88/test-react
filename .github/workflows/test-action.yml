name: Combine SBOMs and Upload to Dependency Track

on:
  push:
    branches:
      - main

jobs:
  combine-sboms:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'
          
      - name: Install dependencies
        run: npm install
      
      - name: Generate SBOM
        run: |
          export FETCH_LICENSE=true
          npm install -g @cyclonedx/cdxgen@8.6.0 && cdxgen -r -o bom.json 
          
      - name: Get SBOM of the existing project
        run: |
          curl -k -X GET "https://dt-api.staging.cryptosoft.com/api/v1/bom/project/fba1e673-92eb-4e7a-a80c-c76be8200221" -H "X-Api-Key: 1DMIXAnGtTIeTQDddlHSvpj6d3as174S" > existing_sbom.json
    
      - name: Upload aggregated SBOM to Dependency Track
        run: | 
          # Base64 encode the generated SBOM content
          #encodedSbom1=$(jq -c . bom.json | base64)
          #encodedSbom2=$(jq -c . existing_sbom.json | base64)
          
          # Array of encoded SBOMs
          files=("bom.json" "existing_sbom.json")
          
           for file in "${files[@]}"; do
                 encoded_sbom=$(jq -c . "$file" | base64) 
                 payloadfile=$(mktemp)
                  cat << EOF > "$payloadfile"
                  {
                    "project": "fba1e673-92eb-4e7a-a80c-c76be8200221",
                    "bom": "$encoded_sbom"
                  }
          EOF
        
                # API request to upload the file to Dependency Track using --form 
               response_file=$(mktemp)
               curl -k -X PUT "https://dt-api.staging.cryptosoft.com/api/v1/bom" \
                     -H "Content-Type: application/json" \
                     -H "X-Api-Key: 1DMIXAnGtTIeTQDddlHSvpj6d3as174S " \
                     -d @"$payloadfile"    > "$response_file"
                 # Print the response for each SBOM
                cat "$response_file"
                 # Add a newline after each API response
                #echo
            done

      - name: Cleanup
        run: |
          rm "bom.json"
